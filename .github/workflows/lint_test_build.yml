on:
  push:
    branches:
    - '!main'
  pull_request:
    types:
      - opened
      - synchronize

name: PR checks

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - uses: actions/cache@v2
        id: cache-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn install --immutable --immutable-cache

  accounts:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn workspace accounts lint
      - run: yarn workspace accounts format:check
      - run: yarn install --immutable --immutable-cache
      - run: yarn workspace accounts test
      - uses: actions/upload-artifact@v2
        with:
          name: x86_64-linux-gnu
          path: |
            /usr/lib/x86_64-linux-gnu/librt-2.31.so
            /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so
            /usr/lib/x86_64-linux-gnu/libc-2.31.so
            /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
            /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
            /usr/lib/x86_64-linux-gnu/libm-2.31.so
            /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.28
            /usr/lib/x86_64-linux-gnu/libdl-2.31.so
            /usr/lib/x86_64-linux-gnu/libutil-2.31.so
            /usr/lib/x86_64-linux-gnu/ld-2.31.so

  backend:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn workspace backend lint
      - run: yarn workspace backend format:check
      - run: yarn workspace backend test

  connector:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn workspace connector lint
      - run: yarn workspace connector format:check
      - run: yarn install --immutable --immutable-cache
      - run: yarn build
      - run: yarn workspace connector test

  frontend:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn workspace frontend lint
      - run: yarn workspace frontend format:check
      - run: yarn workspace frontend test

  rates:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}
      - run: yarn workspace rates lint
      - run: yarn workspace rates format:check
      - run: yarn workspace rates test

  # build:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - accounts
  #     - backend
  #     - connector
  #     - frontend
  #     - rates
  #   steps:
  #     - uses: actions/cache@v2
  #       id: restore-build
  #       with:
  #         path: ./*
  #         key: ${{ github.sha }}
  #     - run: yarn install --immutable --immutable-cache
  #     - run: yarn build
